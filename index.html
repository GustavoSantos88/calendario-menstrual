<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Calendário Menstrual</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>
  <style>
    .fc-event {
      background-color: #fca5a5 !important;
      border: none !important;
    }
  </style>
</head>

<body class="bg-pink-50 min-h-screen p-4">
  <div class="max-w-3xl mx-auto bg-white shadow-lg rounded-xl p-6">
    <h1 class="text-3xl font-bold text-center mb-6">Calendário Menstrual</h1>
    <div id="calendar"></div>
  </div>
  <script>

    document.addEventListener('DOMContentLoaded', function () {
      // Função que gera chave para localStorage por mês/ano do calendário
      function getStorageKey(year, month) {
        // mês no formato 01,02...12 para melhor ordenação e clareza
        const mm = (month + 1).toString().padStart(2, '0');
        return `ciclo_${year}_${mm}`;
      }

      let mesAtual = new Date().getMonth();
      let anoAtual = new Date().getFullYear();

      // Armazena o ciclo do mês/ano atual do calendário
      let cicloAtual = { inicio: null, fim: null };

      const calendarEl = document.getElementById('calendar');

      const calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'pt-br',
        initialView: 'dayGridMonth',
        height: 'auto',
        selectable: true,
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: ''
        },

        // Ao mudar mês, carregar ciclo do mês exibido
        datesSet(info) {
          mesAtual = info.start.getMonth();
          anoAtual = info.start.getFullYear();
          carregarCiclo();
          atualizarEventos();
        },

        select(info) {
          const dataSelecionada = info.startStr;
          const dataSelecionadaDate = new Date(dataSelecionada);
          const inicioDate = cicloAtual.inicio ? new Date(cicloAtual.inicio) : null;
          const fimDate = cicloAtual.fim ? new Date(cicloAtual.fim) : null;

          // Se não tem início → marca início
          if (!cicloAtual.inicio) {
            cicloAtual.inicio = dataSelecionada;
            salvarCiclo();
            atualizarEventos();
            return;
          }

          // Se clicou no dia do início → remove ciclo todo
          if (cicloAtual.inicio === dataSelecionada) {
            removerCiclo();
            cicloAtual = { inicio: null, fim: null };
            atualizarEventos();
            return;
          }

          // Se não tem fim → tenta marcar fim
          if (!cicloAtual.fim) {
            if (dataSelecionadaDate < inicioDate) {
              alert('O fim não pode ser antes do início');
              return;
            }
            cicloAtual.fim = dataSelecionada;
            salvarCiclo();
            atualizarEventos();
            return;
          }

          // Se clicou no dia do fim → remove só o fim
          if (cicloAtual.fim === dataSelecionada) {
            cicloAtual.fim = null;
            salvarCiclo();
            atualizarEventos();
            return;
          }

          // Regras para remarcar fim:
          // Se início e fim estão no mesmo mês, não permite remarcar fim para mês diferente
          if (dataSelecionadaDate > inicioDate) {
            if (fimDate) {
              const inicioMes = inicioDate.getMonth();
              const fimMes = fimDate.getMonth();
              const selecaoMes = dataSelecionadaDate.getMonth();
              const inicioAno = inicioDate.getFullYear();
              const fimAno = fimDate.getFullYear();
              const selecaoAno = dataSelecionadaDate.getFullYear();

              if (inicioMes === fimMes && inicioAno === fimAno) {
                if (selecaoMes !== inicioMes || selecaoAno !== inicioAno) {
                  alert('Para marcar fim em mês diferente, você precisa começar um novo ciclo (remova o atual primeiro).');
                  return;
                }
              }
            }
            cicloAtual.fim = dataSelecionada;
            salvarCiclo();
            atualizarEventos();
            return;
          }

          // Se data selecionada antes do início → remarca início
          if (dataSelecionadaDate < inicioDate) {
            cicloAtual.inicio = dataSelecionada;
            if (fimDate && fimDate < dataSelecionadaDate) {
              cicloAtual.fim = null;
            }
            salvarCiclo();
            atualizarEventos();
            return;
          }
        },
        events: []
      });

      function carregarCiclo() {
        const key = getStorageKey(anoAtual, mesAtual);
        const data = JSON.parse(localStorage.getItem(key));
        if (data) {
          cicloAtual = data;
        } else {
          cicloAtual = { inicio: null, fim: null };
        }
      }

      function salvarCiclo() {
        const key = getStorageKey(anoAtual, mesAtual);
        localStorage.setItem(key, JSON.stringify(cicloAtual));
      }

      function removerCiclo() {
        const key = getStorageKey(anoAtual, mesAtual);
        localStorage.removeItem(key);
      }

      function atualizarEventos() {
        calendar.removeAllEvents();

        if (!cicloAtual.inicio) {
          calendar.render();
          return;
        }

        calendar.addEvent({
          id: 'inicio',
          title: 'Início',
          start: cicloAtual.inicio,
          allDay: true,
          color: '#f87171',
        });

        if (cicloAtual.fim) {
          const fimMaisUm = new Date(cicloAtual.fim);
          fimMaisUm.setDate(fimMaisUm.getDate() + 1);

          calendar.addEvent({
            id: 'fim',
            title: 'Fim',
            start: cicloAtual.fim,
            allDay: true,
            color: '#f87171',
          });

          calendar.addEvent({
            id: 'ciclo',
            title: 'Ciclo',
            start: cicloAtual.inicio,
            end: fimMaisUm.toISOString().split('T')[0],
            allDay: true,
            color: '#fca5a5',
          });
        }

        calendar.render();
      }

      // Inicializa calendário e carrega ciclo do mês atual
      calendar.render();
      carregarCiclo();
      atualizarEventos();

    });
  </script>
</body>

</html>